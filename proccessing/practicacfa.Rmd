---
title: 'Práctica CFA'
author: "Daniel Miranda"
date: "13-01-2021"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
pacman::p_load(lavaan, # pacman para instalar / cargar 
               psych, # para funcion lowerMat
               Hmisc, # rcorr
               stargazer,
               xtable,
               semPlot,
               semTools,
               remedy
               )

```


```{r message=FALSE, warning=FALSE, cache=FALSE, include=FALSE, results="asis"}
rm(list = ls()) #limpiar la memoria
#Desactivar notaci?n cient?fica
options(scipen=999)

pacman::p_load(dplyr, texreg, xtable, stargazer, # Reporte a latex
sjPlot, sjmisc, # reporte y gráficos
skimr,
corrplot, # grafico correlaciones
xtable, # Reporte a latex
Hmisc, # varias funciones
psych, # fa y principal factors
psy, # scree plot function
nFactors, # parallel
GPArotation, devtools, CTT, lavaan, semTable, GGally, QuantPsyc) 
```

# Análisis Factorial Exploratorio

## Conceptos esenciales

- Factores: variables latentes que están a la base de las
correlaciones entre los indicadores

- Cargas factoriales: medida estandarizada de asociación
(correlación) entre el indicador y la variable latente

- Comunalidad: proporción de la varianza del indicador que se asocia a factor(es) comun(es)

- Varianza única (uniqueness): 1-comunalidad

- Eigenvalues: medida de proporción de la varianza total correspondiente a cada uno de los factor (SS loadings)

- Proporción de varianza total explicada por el factor =
eigenvalue / número de indicadores

## Pasos a seguir

- Leer y preparar datos
- Descriptivos generales
- Análisis de supuestos


- Analizar correlaciones
- Extracción de factores
- Métodos de rotación
- Interpretación y reporte

### Leer y preparar datos

```{r eval=TRUE, echo=TRUE, warning=FALSE}
load("../input/data/ICCS16.Rdata")
#skim(iccs16)
#names(iccs16)


chile = iccs16 %>%
  filter(COUNTRY== "CHL")%>%
  mutate(country         = COUNTRY) %>%
  mutate(idcountry       = IDCNTRY) %>%
  mutate(idschool        = IDSCHOOL) %>%
  mutate(idstudent       = IDSTUD) %>%

  #TRUST
  mutate(s_intrust       = S_INTRUST) %>% #TRUST IN CIVIC INSTITUTIONS 
  mutate(nac_gob         = 5 - IS3G26A) %>%   #TRUST INSTITUTIONS-NATIONAL GOVERNMENT 
  mutate(local_gob       = 5 - IS3G26B) %>%   #TRUST INSTITUTIONS-LOCAL GOVERNMENT 
  mutate(courts          = 5 - IS3G26C) %>%   #TRUST INSTITUTIONS-COURTS
  mutate(police          = 5 - IS3G26D) %>%   #TRUST INSTITUTIONS-POLICE
  mutate(pol_parties     = 5 - IS3G26E) %>%   #TRUST INSTITUTIONS-POLITICAL PARTIES
  mutate(parliament      = 5 - IS3G26F) %>%   #TRUST INSTITUTIONS-PARLIAMENT
  mutate(media           = 5 - IS3G26G) %>%   #TRUST INSTITUTIONS-MEDIA
  mutate(ffaa            = 5 - IS3G26I) %>%   #TRUST INSTITUTIONS-FFAA
  mutate(school          = 5 - IS3G26J) %>%   #TRUST INSTITUTIONS-SCHOOL
  mutate(unit_nations    = 5 - IS3G26K) %>%   #TRUST INSTITUTIONS-UNITED NATIONS
  mutate(people          = 5 - IS3G26L) %>%   #TRUST INSTITUTIONS-PEOPLE
  mutate(social          = 5 - IS3G26H) %>%   #TRUST INSTITUTIONS-SOCIAL MEDIA
  #Dummies
  mutate(nac_gob_d         = recode(nac_gob,     "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(local_gob_d       = recode(local_gob,   "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(courts_d          = recode(courts,      "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(police_d          = recode(police,      "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(pol_parties_d     = recode(pol_parties, "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(parliament_d      = recode(parliament,  "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(media_d           = recode(media,       "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(ffaa_d            = recode(ffaa,        "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(school_d          = recode(school,      "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(unit_nations_d    = recode(unit_nations,"1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(people_d          = recode(people,      "1"=0, "2"=0, "3"=1, "4"=1)) %>%
  mutate(social_d          = recode(social,      "1"=0, "2"=0, "3"=1, "4"=1)) %>%


  dplyr::select(nac_gob, local_gob, courts, police, pol_parties, parliament, media, ffaa,school,unit_nations,people,social)

skim(chile)


#chile= chile%>%
#  na.omit()
  
```

### Exploración de la Escala de Confianza en Instituciones.

![](trust.png)



### Descriptivos
```{r remedy002}
trust= chile%>%
 dplyr::select(nac_gob, local_gob, courts, police, pol_parties, parliament, media, ffaa,school,unit_nations,people,social)
#summary(trust)
stargazer(trust,title="Estadísticos descriptivos", type = "text")

```



### Matriz de correlaciones
```{r }
corMat  <- cor(trust, use="na.or.complete")  # estimar matriz pearson
options(digits=3) # decimales
print(corMat)

stargazer(corMat, title="correlaciones", type = "text") #Latex table
```


```{r }
M=cor(trust, use="na.or.complete")
corrplot(M, type="lower",
      order="AOE", cl.pos="b", tl.pos="d") #agrega nombres en diag.
```

```{r }
sjp.corr(trust, na.deletion = c("listwise"))
```

### Análisis de supuestos

- KMO: factorizabilidad 
```{r }
KMO(corMat) 

```
0.00 to 0.49 inaceptable.

0.50 to 0.59 miserable.

0.60 to 0.69 mediocre.

0.70 to 0.79 medio.

0.80 to 0.89 meritorio.

0.90 to 1.00 maravilloso.



- Esfericidad
```{r }
cortest.bartlett(corMat, n = 5081)
```

- Normalidad (univariada)
```{r }
shapiro.test(trust$nac_gob)
```


### Análisis factorial explotatorio: extracción

```{r}
scree.plot(trust)
```



```{r }
fac2 <- fa(r = trust, fm= "ml", nfactors=3, rotate="promax")
fac2

factor.plot(fac2, labels=rownames(fac2$loadings))

#fa.parallel(corMat, n.obs=5081)
```


```{r}
fa.diagram(fac2)
```




Técnica para analizar dimensionalidad para indicadores múltiples, considerando el error de medición en la estimación (separando lo común de lo único). 

```{r }
fac <- fa(r = trust, fm= "ml", nfactors=2, rotate="promax")
fac
factor.plot(fac, labels=rownames(fac$loadings))
scree.plot(trust)
#fa.parallel(corMat, n.obs=5081)
```



### Análisis factorial explotatorio: rotación
```{r }
fac <- fa(r = trust, fm= "ml", nfactors=2, rotate="varimax")
fac
```

### Análisis factorial explotatorio: rotación
```{r }
fac <- fa(r = trust, fm= "ml", nfactors=2, rotate="promax")
fac
```
